import Anthropic from '@anthropic-ai/sdk';
import { storage } from "../storage";

// Define types for the response
interface ArticleContent {
  title: string;
  content: string;
  snippet: string;
}

interface FAQ {
  question: string;
  answer: string;
}

export class AnthropicService {
  private async getApiKey(): Promise<string> {
    // First try to get the key from environment variables
    const envApiKey = process.env.ANTHROPIC_API_KEY;
    
    if (envApiKey) {
      return envApiKey;
    }
    
    // Fallback to stored settings if env variable is not available
    const settings = await storage.getApiSettings();
    
    if (!settings || !settings.anthropicApiKey) {
      throw new Error("Anthropic API key not configured");
    }
    
    return settings.anthropicApiKey;
  }
  
  /**
   * Safely extracts text content from Anthropic's response
   */
  private extractTextContent(response: any): string {
    try {
      if (!response || !response.content || !response.content.length) {
        throw new Error("Empty response from Anthropic API");
      }
      
      const firstContent = response.content[0];
      
      // Handle different response formats
      if (typeof firstContent === 'string') {
        return firstContent;
      } else if (firstContent && typeof firstContent.text === 'string') {
        return firstContent.text;
      } else if (firstContent && firstContent.type === 'text' && typeof firstContent.text === 'string') {
        return firstContent.text;
      } else {
        // If we can't find the text in expected places, try to stringify the entire response
        const contentStr = JSON.stringify(firstContent);
        if (contentStr && contentStr.length > 0) {
          return contentStr;
        }
      }
      
      throw new Error("Could not extract text from Anthropic API response");
    } catch (error) {
      console.error("Failed to extract text from response:", error);
      throw new Error("Failed to extract text from Anthropic API response");
    }
  }
  
  /**
   * Generate article content using Anthropic API
   * Creates an SEO-optimized affiliate article with proper product links and formatting
   */
  async generateArticleContent(
    keyword: string,
    products: any[],
    post: {
      affiliateLinks?: any[];
      description?: string;
      secondaryKeywords?: string[];
    } = {},
    options: {
      maxTokens?: number;
      temperature?: number;
    } = {}
  ): Promise<ArticleContent> {
    try {
      const apiKey = await this.getApiKey();
    
      
      // Create the system prompt for Anthropic
      try {
        const keywords = [keyword];
        const secondaryKeywords = post.secondaryKeywords || [];
        const mainKeywords = secondaryKeywords.length > 0 ? secondaryKeywords : keywords;

        const client = new Anthropic({ apiKey });
        const ANTHROPIC_MODEL = "claude-3-5-haiku-latest";

        console.log("Step 1: Generating title and outline...");   
        const outlinePrompt = `You are a professional SEO blog writer for an Amazon affiliate website.

      Write a helpful and engaging blog post about: ${mainKeywords.join(", ")}.

      Please naturally incorporate these product-related keywords as well: ${keywords.join(", ")}.

      ${
          post.description ? `Additional Context from User:
      ${post.description}` : ""
        }

      Instructions:
      1. Use grade 5-6 level Canadian English
      2. Keep a warm, friendly tone like you're helping a fellow shopper
      3. Do NOT mention yourself or the writing process
      4. Do NOT say “this article” or “this blog”
      5. Create an SEO-friendly title (60–70 characters)
      6. Create a clear outline with 2–3 main sections
      7. Each section should include:
         - One H2 heading that’s relevant
         - 1–2 H3 subheadings underneath
         - Each H2 must represent an affiliate product
         - Each product heading must be a clickable affiliate link
         - Each product image must also be a clickable affiliate link

      Format your response as JSON:
      {
        "title": "Your Blog Post Title",
        "outline": [
          { 
            "heading": "Product Section Title",
            "subheadings": ["Subheading 1", "Subheading 2"],
            "affiliate_connection": "Name of the Amazon product to feature in this section"
          }
        ]
      }`;

        const outlineResponse = await client.messages.create({
          model: ANTHROPIC_MODEL,
          max_tokens: 1000,
          temperature: 0.7,
          messages: [{ role: "user", content: outlinePrompt }],
        });

        const outlineText = extractTextFromResponse(outlineResponse);
        console.log("Outline response text:", outlineText);

        const outlineJson =
          outlineText.match(/```json\s*([\s\S]*?)\s*```/) ||
          outlineText.match(/{[\s\S]*}/);

        if (!outlineJson) {
          console.error("No JSON found in outline response");
          throw new Error("Failed to extract JSON from outline response");
        }

        let jsonStr = Array.isArray(outlineJson) ? outlineJson[1] || outlineJson[0] : outlineJson;
        jsonStr = jsonStr.replace(/```json|```/g, "").trim();
        jsonStr = jsonStr.replace(/[\u0000-\u001F\u007F]/g, "");

        let outlineResult;
        try {
          outlineResult = JSON.parse(jsonStr);
        } catch (e) {
          console.error("Failed to parse outline JSON:", e, outlineJson);
          outlineResult = {
            title: "Blog Post About " + keywords.join(", "),
            outline: [],
          };
        }

        const excerptPrompt = `In a happy, cheerful, and conversational tone write a catchy, 1-2 sentence excerpt for a blog post titled "${outlineResult.title}" that entices readers to continue reading.`;
        const excerptResponse = await client.messages.create({
          model: ANTHROPIC_MODEL,
          max_tokens: 150,
          temperature: 0.7,
          messages: [{ role: "user", content: excerptPrompt }],
        });
        const postExcerpt = trimToCompleteSentence(extractTextFromResponse(excerptResponse));

        let affiliateLinksHTML = "";
        if (Array.isArray(post.affiliateLinks) && post.affiliateLinks.length > 0) {
          const validAffiliateLinks = post.affiliateLinks.filter(link => link.name && link.url);
          if (validAffiliateLinks.length > 0) {
            affiliateLinksHTML = `<div class=\"product-links\">\n` +
              validAffiliateLinks.map(link => `<p><strong>Best for:</strong> <a href=\"${link.url}\" target=\"_blank\" rel=\"nofollow\">${link.name}</a></p>`).join("\n") +
              `\n</div>`;
          }
        }

        const introPrompt = `Write an engaging introduction for "${outlineResult.title}".
      Include:
      - A hook that grabs attention
      - Brief mention of key benefits readers will get
      - Natural transition to the first section: "${outlineResult.outline[0]?.heading || "First Section"}"
      Instructions:
      1. Use grade 5-6 level Canadian English
      2. Keep a cheerful, friendly tone — like you're chatting with a fellow shopper
      3. Make it helpful, warm, and down-to-earth
      4. Keep emoji usage minimal - only if absolutely necessary
      5. Include keywords naturally
      6. Give a clear overview of what readers will learn

      Important: End at the previous sentence. Do NOT leave content hanging.
      Format with <p> tags only.`;

        const introResponse = await client.messages.create({
          model: ANTHROPIC_MODEL,
          max_tokens: 500,
          temperature: 0.7,
          messages: [{ role: "user", content: introPrompt }],
        });

        let fullContent = "";
        fullContent += `<h1>${outlineResult.title}</h1>\n\n`;
        fullContent += `<p><strong>${postExcerpt}</strong></p>\n\n`;
        fullContent += `${affiliateLinksHTML}\n\n`;

        let introContent = extractTextFromResponse(introResponse);
        introContent = trimToCompleteSentence(introContent);
        fullContent += `${introContent}\n\n`;

        // === Product Sections ===
        for (const section of outlineResult.outline || []) {
          const product = post.affiliateLinks.find(p => p.name === section.affiliate_connection);
          if (!product) continue;

          const productPrompt = `Write a 400-token product review for "${product.title}".
      Include:
      - An <h2> tag with the product name, wrapped in a <a> to its affiliate URL
      - A product image wrapped in a <a> tag linking to the same affiliate URL
      - 1–2 <h3> subheadings and content for each
      - Real-world use cases, benefits, or specs as <p> content
      - Use <ul> or <table> if needed for clarity

      Product Details:
      Title: ${product.title}
      ASIN: ${product.asin}
      Description: ${product.description}
      Image URL: ${product.imageUrl}
      Affiliate Link: ${product.affiliateLink}

      Subheadings:
      ${section.subheadings.map((sub, i) => `${i + 1}. ${sub}`).join("\n")}

          const productResponse = await client.messages.create({
            model: ANTHROPIC_MODEL,
            max_tokens: 400,
            temperature: 0.7,
            messages: [{ role: "user", content: productPrompt }],
          });

          const productContent = trimToCompleteSentence(extractTextFromResponse(productResponse));
          fullContent += productContent + "\n\n";
        }

        // === Wrap-Up Section ===
  z`

        const wrapContent = trimToCompleteSentence(extractTextFromResponse(wrapResponse));
        fullContent += wrapContent + "

      ";

        // === FAQ Section ===
        const faqPrompt = `Write 5 detailed FAQs related to "${outlineResult.title}".
      Each FAQ should use <h3> for the question and <p> tags for the answer.
      Topics to cover:
      - Pricing expectations
      - Ease of installation/setup
      - Who the product is for
      - Strengths vs. limitations
      - Comparison with other brands
      Format using plain HTML. Avoid any markdown or extra syntax.`;

        const faqResponse = await client.messages.create({
          model: ANTHROPIC_MODEL,
          max_tokens: 800,
          temperature: 0.7,
          messages: [{ role: "user", content: faqPrompt }],
        });

        const faqContent = trimToCompleteSentence(extractTextFromResponse(faqResponse));
fullContent += `<h2>Frequently Asked Questions</h2>

` + faqContent;

return {
  title: outlineResult.title,
  snippet: postExcerpt,
  content: fullContent.trim(),
};


      } catch (error) {
        console.error("Error generating content:", error);
        throw error;
      }

      
      // Extract the content
      const content = this.extractTextContent(response);
      
      // Extract JSON from the response
      const jsonMatch = content.match(/```json\s*([\s\S]*?)\s*```/) || 
                        content.match(/{[\s\S]*}/) ||
                        content.match(/\[\s*{\s*"question"[\s\S]*}\s*\]/);
      
      if (!jsonMatch) {
        throw new Error("Failed to parse JSON from generated FAQs");
      }
      
      const jsonStr = jsonMatch[0].replace(/```json|```/g, '').trim();
      const faqs = JSON.parse(jsonStr);
      
      return Array.isArray(faqs) ? faqs : [faqs];
      
    } catch (error) {
      console.error("Anthropic FAQ generation failed:", error);
      throw new Error(`Failed to generate FAQs: ${error instanceof Error ? error.message : 'Unknown error'}`);
    }
  }
}

export const anthropicService = new AnthropicService();
